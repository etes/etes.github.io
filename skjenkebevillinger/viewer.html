<!DOCTYPE html>
<html>
	<head>
		<title></title>	<!-- Define the versions of IE that will be used to render the page. See Microsoft documentation for details. Optional. -->

    	<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta charset="utf-8">
		<!-- Responsive -->
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<meta name="mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="default">
		<!-- End Responsive -->
		<!-- Use protocol relative urls that way if the browser is viewing the page via HTTPS the js/css file will be requested using the HTTPS protocol -->
		<link rel="stylesheet" href="//js.arcgis.com/3.13/esri/css/calcite/calcite.css">

        <link rel="stylesheet"  href="//js.arcgis.com/3.13/esri/css/esri.css">
		<!-- Load any application specific styles -->
		<link rel="stylesheet" href="css/styles.css">
		<!--[if IE 8]>
			<link rel="stylesheet" href="css/ie.css">
		<![endif]-->

  <link rel="stylesheet" href="//code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
	</head>
	<body class="calcite app-loading no-touch">

	<nav>
    <ul class="cf">
      <li><a href="/viwer.html?webmap=6ac9719afe604973b4d6af571e88c382">Full</a></li>
      <li><a href="/viewer.html?webmap=a4951172bb70470497b240ca8d896cf8">Innsynkart</a></li>
    </ul>
  </nav>
		<!-- Loading Indicator
		<div class="loading-indicator">
			<div class="loading-message" id="loading_message"></div>
		</div>
		-->
		<div data-role="page" id="map" data-theme="a" style="overflow-x: visible !important">

		<!-- Map -->
		<!-- The ArcGIS API for JavaScript provides bidirectional support.  When viewing the application in an right to left (rtl) language like Hebrew and Arabic the map needs to remain in left-to-right (ltr) mode. Specify this by setting the dir attribute on the div to ltr. -->
		<div id="mapDiv" dir="ltr">



		</div>

		<!-- Panel Content -->
		<div id="panelContent">
			<div id="panelPages"></div>
		</div>

		<!-- Panel Top -->
		<div id="panelTop" class="bg rounded shadow">
			<!-- Panel Title -->
			 <div id="panelTitle">
				<div class="fc" id="panelText">
                    <div id="title"></div>
                    <div id="subtitle"></div>
                </div>

				<div id="searchInputDiv" class="arcgisSearch"></div>

				<div id="panelMenu" class="icon-menu icon-color"></div>
			</div>

			<!-- Panel Tools -->
			<div id="panelTools">
				<!--Tools are created programatically-->
			</div>
		</div>
	</div>

		<script src="//code.jquery.com/jquery-1.12.3.min.js"></script>
		<script src="//code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
		<script src="js/libs/jquery.validate.min.js"></script>
		<script src="js/vendor/native.history.js"></script>

		<script type="text/javascript">
			var package_path = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
			var dojoConfig = {
				// The locationPath logic below may look confusing but all its doing is
				// enabling us to load the api from a CDN and load local modules from the correct location.
				packages : [{
					name : "application",
					location : package_path + '/js'
				}, {
					name : "config",
					location : package_path + '/config'
				}, {
					name : "arcgis_templates",
					location : package_path + '/..'
				}]
			};
		</script>

		<script type="text/javascript" src="//js.arcgis.com/3.13/"></script>
		<script type="text/javascript">
			(function() {
				'use strict';
				var queryString = {};
				// Bind to StateChange Event
    History.Adapter.bind(window,'statechange',function(){ // Note: We are using statechange instead of popstate
        var State = History.getState(); // Note: We are using History.getState() instead of event.state
    });

				queryString.parse = function(str) {
					if ( typeof str !== 'string') {
						return {};
					}

					str = str.trim().replace(/^\?/, '');


					if (!str) {
						return {};
					}

					return str.trim().split('&').reduce(function(ret, param) {
						var parts = param.replace(/\+/g, ' ').split('=');
						var key = parts[0];
						var val = parts[1];

						key = decodeURIComponent(key);
						// missing `=` should be `null`:
						// http://w3.org/TR/2012/WD-url-20120524/#collect-url-parameters
						val = val === undefined ? null : decodeURIComponent(val);

						if (!ret.hasOwnProperty(key)) {
							ret[key] = val;
						} else if (Array.isArray(ret[key])) {
							ret[key].push(val);
						} else {
							ret[key] = [ret[key], val];
						}
						return ret;
					}, {});
				};


				queryString.stringify = function(obj) {
					return obj ? Object.keys(obj).map(function(key) {
						var val = obj[key];

						if (Array.isArray(val)) {
							return val.map(function(val2) {
								return encodeURIComponent(key) + '=' + encodeURIComponent(val2);
							}).join('&');
						}

						return encodeURIComponent(key) + '=' + encodeURIComponent(val);
					}).join('&') : '';
				};

				queryString.push = function(key, new_value) {
					var params = queryString.parse(location.search);
					params[key] = new_value;
					var new_params_string = queryString.stringify(params);

					//Warning! pushState is not supported in IE 9 and older
					console.log(window.location);
					History.pushState({}, "", window.location.pathname + '?' + new_params_string);
				};
				if ( typeof module !== 'undefined' && module.exports) {
					module.exports = queryString;
				} else {
					window.queryString = queryString;
				}
			})();
		</script>
		<script type="text/javascript">

			require([
				"dojo/parser",
				"config/templateConfig",
				"application/template",
				"application/main",
				"dijit/layout/BorderContainer",
				"dijit/layout/ContentPane",
				"dijit/layout/StackContainer"
			], function(
				parser,
				templateConfig,
				Template,
				Main
			){

				var webMaps = {
						'full' : '6ac9719afe604973b4d6af571e88c382',
						'innsyn' : 'a4951172bb70470497b240ca8d896cf8'
					};

					// Do we have a viewer specified?
	                var uri = document.URL;
	                var query;
	                if (uri.indexOf("#") > 0) {
	                    query = uri.substring(uri.indexOf("?") + 1, uri.indexOf("#"));
	                } else {
	                    query = uri.substring(uri.indexOf("?") + 1, uri.length);
	                }
	                var urlParams = dojo.queryToObject(query);

									console.log(urlParams);

									// If a configuration base has been specified, use it to update the default configuration.
                if (urlParams.hasOwnProperty("webmap")) {
                    var configBase = urlParams["webmap"];
										console.log(configBase);


                }



				var urlParams = queryString.parse(location.search);
				if (urlParams.webmap != undefined){

					mapLoader(urlParams.webmap);

					//link != undefined ? "http://www.fredrikstad.no" + link : '');
				}
				else {
					mapLoader('6ac9719afe604973b4d6af571e88c382');
				}

				//Landing Dialog to choose a map

				function mapChooser() {
					$(':mobile-pagecontainer').pagecontainer('change', '#landingDialog', {
						reload : false
					});

					$('#mapForm').validate({// initialize the plugin
						rules : {
							mapList : {
								required : true
							}
						},
						messages : {
							mapList : {
								required : "Vennligst velg et kart!"
							}
						},
						submitHandler : function(form){

							var activeMap = $("#mapList").val();

							if (activeMap) {
								mapLoader(webMaps[activeMap]);
							} else {
								mapLoader('6ac9719afe604973b4d6af571e88c382');
							}

							$(':mobile-pagecontainer').pagecontainer('change', '#map', {
								reload : false
							});
							//queryString.push('webmap', webMaps[activeMap]);
							return false;

						},
						errorPlacement : function(error, element) {
							error.css({
								width : 'inherit',
								color : 'red'
							});

							error.appendTo(element.parent().prev());
							if (element.is('select')) {
								error.insertAfter(element.parents('div.ui-select'));
							} else {
								error.insertAfter(element);
							}
						}
					});
				}

				function mapLoader(webmapid) {

					queryString.push('webmap', webmapid);

					parser.parse();
					// create the template. This will take care of all the logic required for template applications
					var myTemplate = new Template(templateConfig);
					// create my main application. Start placing your logic in the main.js file.
					var myApp = new Main();
					// start template
					myTemplate.startup().then(function(config) {
						// The config object contains the following properties: helper services, (optionally)
						// i18n, appid, webmap and any custom values defined by the application.
						// In this example we have one called theme.
						myApp.startup(config);
					}, function(error) {
						// something went wrong. Let's report it.
						myApp.reportError(error);
					});
				}
			});
		</script>

	</body>

</html>
