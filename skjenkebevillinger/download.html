<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=7" />
    <title>JSAPIExportToExcel</title>
    <style type="text/css">
        @import "http://serverapi.arcgisonline.com/jsapi/arcgis/3.2/js/dojo/dijit/themes/tundra/tundra.css";
        @import "http://js.arcgis.com/3.2/js/esri/css/esri.css";
    </style>

    <script type="text/javascript">
        djConfig = {
            parseOnLoad: true,
            isDebug: true
        };
    </script>

    <script type="text/javascript" src="http://serverapi.arcgisonline.com/jsapi/arcgis/?v=3.2"></script>

    <script type="text/javascript">
        dojo.require("esri.map");
        var map, queryTask, query;
        var outfieldsarray = ["OBJECTID","ORGANISASJONSNUMMER","SKJENKESTEDETS_NAVN","SKJENKESTEDETS_ADRESSE","STATUS","TYPE_VIRKSOMHET"];


        // main initialization
        //
        function init() {
            initExtent = {
              xmax: 613361.7246775525,
              xmin: 609297.7165495362,
              ymax: 6565980.786968215,
              ymin: 6564405.983818608,
              "spatialReference":{"wkid":25832}
            };
            map = new esri.Map("map", {
                extent: new esri.geometry.Extent(initExtent),
                logo: false
            });
            map.addLayer(new esri.layers.ArcGISTiledMapServiceLayer("http://kart.fredrikstad.kommune.no/arcgis/rest/services/Felles/GrunnkartGraatone/MapServer"));
            map.addLayer(new esri.layers.ArcGISDynamicMapServiceLayer("http://kart.fredrikstad.kommune.no/arcgis/rest/services/Prosjekter/skjenkesteder/MapServer"));



            //build query task
            queryTask = new esri.tasks.QueryTask("http://kart.fredrikstad.kommune.no/arcgis/rest/services/Prosjekter/skjenkesteder/MapServer/0");
            query = new esri.tasks.Query();
            query.returnGeometry = true;

            // Grid Handler
            dojo.connect(dojo.byId("gen_btn"), "onclick", executeQuery);
        }

        function executeQuery() {
            console.debug("function: selectFeaturesAndResetMapDisplay(extent)");
            // debugger;
            console.debug("`- selectionLayer cleared");


            //build query filter
            //query.geometry = extent;
            query.returnGeometry = true;
            query.outFields = ["*"];
            query.where = "1=1";
            query.outSpatialReference = new esri.SpatialReference({"wkid": "4326"});
            console.debug("`- query prepared");

            // Prepare table2csv
            console.debug("`- prepare table2csv");


            //Execute task and call showResults on completion
            queryTask.execute(query, function(fset) {
                        console.debug("`-> execute query begin:");
                        console.log("|`- number of features: " + fset.features.length);
                        var items = [];
                        for (var i = 0; i < fset.features.length; i++) {
                            var attributes = fset.features[i].attributes;
                            var geom = fset.features[i].geometry;
                            attributes.LATITUDE = geom.y;
                            attributes.LONGITUDE = geom.x;
                            items.push(attributes);
                        }

                json2csv(items, true);
                    });
        };

        function json2csv(JSONData, ShowLabel) {
        //If JSONData is not an object then JSON.parse will parse the JSON string in an Object
        var arrData = typeof JSONData != 'object' ? JSON.parse(JSONData) : JSONData;

        var CSV = '';
        //This condition will generate the Label/Header
        if (ShowLabel) {
        var row = "";

        //This loop will extract the label from 1st index of on array
        for (var index in arrData[0]) {

            //Now convert each value to string and comma-seprated
            row += index + ';';
        }

        row = row.slice(0, -1);

        //append Label row with line break
        CSV += row + '\r\n';
        }

        //1st loop is to extract each row
        for (var i = 0; i < arrData.length; i++) {
        var row = "";

        //2nd loop will extract each column and convert it in string comma-seprated
        for (var index in arrData[i]) {
            row += '"' + arrData[i][index] + '";';
        }

        row.slice(0, row.length - 1);

        //add a line break after each row
        CSV += row + '\r\n';
        }

        if (CSV == '') {
        alert("Invalid data");
        return;
        }

        //Generate a file name
        var fileName = "MyReport_";
        //this will remove the blank-spaces from the title and replace it with an underscore
        fileName += "test".replace(/ /g,"_");

        //Initialize file format you want csv or xls
        var uri = 'data:text/csv;charset=utf-8,' + escape(CSV);
        
        download(CSV, fileName + ".csv", "text/plain");
        }

        function download(data, strFileName, strMimeType) {

      		var self = window, // this script is only for browsers anyway...
      			u = "application/octet-stream", // this default mime also triggers iframe downloads
      			m = strMimeType || u,
      			x = data,
      			D = document,
      			a = D.createElement("a"),
      			z = function(a){return String(a);},
      			B = (self.Blob || self.MozBlob || self.WebKitBlob || z);
      			B=B.call ? B.bind(self) : Blob ;
      			var fn = strFileName || "download",
      			blob,
      			fr;


      		if(String(this)==="true"){ //reverse arguments, allowing download.bind(true, "text/xml", "export.xml") to act as a callback
      			x=[x, m];
      			m=x[0];
      			x=x[1];
      		}

      		//go ahead and download dataURLs right away
      		if(String(x).match(/^data\:[\w+\-]+\/[\w+\-]+[,;]/)){
      			return navigator.msSaveBlob ?  // IE10 can't do a[download], only Blobs:
      				navigator.msSaveBlob(d2b(x), fn) :
      				saver(x) ; // everyone else can save dataURLs un-processed
      		}//end if dataURL passed?

      		blob = x instanceof B ?
      			x :
      			new B([x], {type: m}) ;


      		function d2b(u) {
      			var p= u.split(/[:;,]/),
      			t= p[1],
      			dec= p[2] == "base64" ? atob : decodeURIComponent,
      			bin= dec(p.pop()),
      			mx= bin.length,
      			i= 0,
      			uia= new Uint8Array(mx);

      			for(i;i<mx;++i) uia[i]= bin.charCodeAt(i);

      			return new B([uia], {type: t});
      		 }

      		function saver(url, winMode){

      			if ('download' in a) { //html5 A[download]
      				a.href = url;
      				a.setAttribute("download", fn);
      				a.innerHTML = "downloading...";
      				D.body.appendChild(a);
      				setTimeout(function() {
      					a.click();
      					D.body.removeChild(a);
      					if(winMode===true){setTimeout(function(){ self.URL.revokeObjectURL(a.href);}, 250 );}
      				}, 66);
      				return true;
      			}

      			if(typeof safari !=="undefined" ){ // handle non-a[download] safari as best we can:
      				url="data:"+url.replace(/^data:([\w\/\-\+]+)/, u);
      				if(!window.open(url)){ // popup blocked, offer direct download:
      					if(confirm("Displaying New Document\n\nUse Save As... to download, then click back to return to this page.")){ location.href=url; }
      				}
      				return true;
      			}

      			//do iframe dataURL download (old ch+FF):
      			var f = D.createElement("iframe");
      			D.body.appendChild(f);

      			if(!winMode){ // force a mime that will download:
      				url="data:"+url.replace(/^data:([\w\/\-\+]+)/, u);
      			}
      			f.src=url;
      			setTimeout(function(){ D.body.removeChild(f); }, 333);

      		}//end saver




      		if (navigator.msSaveBlob) { // IE10+ : (has Blob, but not a[download] or URL)
      			return navigator.msSaveBlob(blob, fn);
      		}

      		if(self.URL){ // simple fast and modern way using Blob and URL:
      			saver(self.URL.createObjectURL(blob), true);
      		}else{
      			// handle non-Blob()+non-URL browsers:
      			if(typeof blob === "string" || blob.constructor===z ){
      				try{
      					return saver( "data:" +  m   + ";base64,"  +  self.btoa(blob)  );
      				}catch(y){
      					return saver( "data:" +  m   + "," + encodeURIComponent(blob)  );
      				}
      			}

      			// Blob but not URL:
      			fr=new FileReader();
      			fr.onload=function(e){
      				saver(this.result);
      			};
      			fr.readAsDataURL(blob);
      		}
      		return true;
      	};


        dojo.addOnLoad(init);

    </script>

</head>
<body class="tundra">
    <div id="map" style="width: 1024px; height: 512px; border: 1px solid #000;">
    </div>
    <button class='gen_btn' id="gen_btn">Generate File</button>
</body>
</html>
